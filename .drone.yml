---
kind: pipeline
name: build-container

platform:
  os: linux
  arch: amd64

steps:
  - name: dryrun
    image: thegeeklab/drone-docker-buildx:23
    settings:
      dockerfile: Dockerfile.multiarch
      dry_run: true
      platforms:
        - linux/amd64
        - linux/arm64
        - linux/arm/v7
        - linux/arm/v6
      provenance: false
      repo: thegeeklab/${DRONE_REPO_NAME}
    when:
      ref:
        - refs/pull/**

  - name: publish-dockerhub
    image: thegeeklab/drone-docker-buildx:23
    settings:
      auto_tag: true
      dockerfile: Dockerfile.multiarch
      password:
        from_secret: docker_password
      platforms:
        - linux/amd64
        - linux/arm64
        - linux/arm/v7
        - linux/arm/v6
      provenance: false
      repo: thegeeklab/${DRONE_REPO_NAME}
      username:
        from_secret: docker_username
    when:
      ref:
        - refs/heads/main
        - refs/tags/**
    depends_on:
      - dryrun

  - name: publish-quay
    pull: always
    image: docker.io/xoxys/drone-docker-buildx:debug
    settings:
      auto_tag: true
      dockerfile:
        from_secret: debug_string
      log_level: debug
      platforms:
        - linux/amd64
        - linux/arm64
        - linux/arm/v7
        - linux/arm/v6
      provenance: false
      registries:
        - password:
            from_secret: debug_string
          registry: quay.io
          username:
            from_secret: debug_string
      repo: quay.io/thegeeklab/${DRONE_REPO_NAME}
    when:
      ref:
        - refs/heads/main
        - refs/tags/**
    depends_on:
      - dryrun

trigger:
  ref:
    - refs/heads/main
    - refs/tags/**
    - refs/pull/**

---
kind: signature
hmac: 51143668f10f8403862a46301a3a256c39795f98b0fc10e15aa719325a0fa28f

...
